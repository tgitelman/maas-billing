# Perses Dashboard: Platform Admin Dashboard
# GENERATED FROM Grafana source: deployment/components/observability/grafana/dashboards/dashboard-platform-admin.yaml
# Every panel and PromQL query matches the Grafana version except:
#   - Grafana's $__range is replaced with [1h] (Perses does not support $__range)
apiVersion: perses.dev/v1alpha1
kind: PersesDashboard
metadata:
  name: platform-admin-dashboard
  labels:
    app: perses
    app.kubernetes.io/part-of: maas-observability
spec:
  display:
    name: "Platform Admin Dashboard"
    description: "Platform-wide metrics for administrators monitoring the MaaS platform"
  duration: 1h

  variables:
    - kind: ListVariable
      spec:
        name: maas_namespace
        display:
          name: "MaaS Namespace"
        allowMultiple: false
        allowAllValue: true
        defaultValue: "maas-api"
        plugin:
          kind: PrometheusLabelValuesVariable
          spec:
            labelName: namespace
            matchers:
              - kube_pod_info{pod=~"maas-api.*"}
    - kind: TextVariable
      spec:
        name: kuadrant_namespace
        display:
          name: "Kuadrant Namespace"
        value: "kuadrant-system"
    - kind: TextVariable
      spec:
        name: gateway_namespace
        display:
          name: "Gateway Namespace"
        value: "openshift-ingress"
    - kind: TextVariable
      spec:
        name: llm_namespace
        display:
          name: "LLM Namespace"
        value: "llm"
    - kind: ListVariable
      spec:
        name: model
        display:
          name: "Model"
        allowMultiple: true
        allowAllValue: true
        defaultValue: "$__all"
        plugin:
          kind: PrometheusLabelValuesVariable
          spec:
            labelName: model_name
            matchers:
              - vllm:num_requests_running

  panels:
    # =============================================
    # Section: Component Health (6 panels)
    # =============================================
    limitadorHealth:
      kind: Panel
      spec:
        display:
          name: "üíö Limitador"
          description: "Count of running Limitador pods (rate limiting service). Should be >= 1."
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "Pods"
                  query: count(kube_pod_status_phase{namespace=~"$kuadrant_namespace", pod=~"limitador.*", phase="Running"}) OR vector(0)

    authorinoHealth:
      kind: Panel
      spec:
        display:
          name: "üîê Authorino"
          description: "Count of running Authorino pods (authentication/authorization service). Should be >= 1."
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "Pods"
                  query: count(kube_pod_status_phase{namespace=~"$kuadrant_namespace", pod=~"authorino.*", phase="Running"}) OR vector(0)

    maasApiPods:
      kind: Panel
      spec:
        display:
          name: "üåê MaaS API Pods"
          description: "Count of running MaaS API pods. These handle token generation and model routing."
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "Pods"
                  query: count(kube_pod_status_phase{namespace=~"$maas_namespace", pod=~"maas-api.*", phase="Running"} == 1) OR on() vector(0)

    gatewayPods:
      kind: Panel
      spec:
        display:
          name: "üö™ Gateway Pods"
          description: "Count of running Istio Gateway pods. These are the entry point for all API traffic."
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "Pods"
                  query: count(kube_pod_status_phase{namespace=~"$gateway_namespace", pod=~"maas-default-gateway.*", phase="Running"} == 1) OR on() vector(0)

    firingAlerts:
      kind: Panel
      spec:
        display:
          name: "üö® Firing Alerts"
          description: "Number of currently firing Prometheus alerts for MaaS components. 0 = healthy."
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "Alerts"
                  query: count(ALERTS{alertstate="firing", alertname!="Watchdog", namespace=~"$llm_namespace|$kuadrant_namespace|$maas_namespace|envoy-gateway-system"}) OR vector(0)

    activeAlertsTable:
      kind: Panel
      spec:
        display:
          name: "üìã Active Alerts"
          description: "Currently firing Prometheus alerts for MaaS-related namespaces. Excludes the Watchdog heartbeat alert."
        plugin:
          kind: TimeSeriesTable
          spec: {}
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{alertname}} ({{severity}})"
                  query: ALERTS{alertstate="firing", alertname!="Watchdog", namespace=~"$llm_namespace|$kuadrant_namespace|$maas_namespace|envoy-gateway-system"}

    # =============================================
    # Section: Auth Evaluation (2 panels)
    # =============================================
    authEvaluationLatency:
      kind: Panel
      spec:
        display:
          name: "üîê Auth Evaluation Latency (P50/P95/P99)"
          description: "Authentication/authorization evaluation latency. Shows how long Authorino takes to evaluate each request."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: bottom
              mode: table
            yAxis:
              format:
                unit: seconds
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "P50"
                  query: histogram_quantile(0.5, sum(rate(auth_server_authconfig_duration_seconds_bucket[5m])) by (le))
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "P95"
                  query: histogram_quantile(0.95, sum(rate(auth_server_authconfig_duration_seconds_bucket[5m])) by (le))
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "P99"
                  query: histogram_quantile(0.99, sum(rate(auth_server_authconfig_duration_seconds_bucket[5m])) by (le))

    authSuccessDenyRate:
      kind: Panel
      spec:
        display:
          name: "üîê Auth Success / Deny Rate"
          description: "Rate of auth evaluation outcomes from Authorino. Shows successful authentications vs denials over time."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: bottom
              mode: table
            yAxis:
              format:
                unit: decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{status}}"
                  query: sum by (status) (rate(auth_server_authconfig_response_status[5m]))

    # =============================================
    # Section: Key Metrics (8 panels)
    # =============================================
    totalTokensConsumed:
      kind: Panel
      spec:
        display:
          name: "üìä Total Tokens"
          description: "Total tokens consumed by successful API requests."
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: decimal
              shortValues: true
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "Tokens"
                  query: sum(authorized_hits)

    totalRequests:
      kind: Panel
      spec:
        display:
          name: "üìä Total Requests"
          description: "Total API requests that were successfully authorized."
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: decimal
              shortValues: true
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "Requests"
                  query: sum(authorized_calls)

    tokenRate:
      kind: Panel
      spec:
        display:
          name: "‚ö° Token Rate"
          description: "Current token consumption rate (tokens per second) averaged over the last 5 minutes."
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: decimal
              decimalPlaces: 2
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "tokens/s"
                  query: sum(rate(authorized_hits[5m]))

    requestRate:
      kind: Panel
      spec:
        display:
          name: "‚ö° Request Rate"
          description: "Current request rate (requests per second) averaged over the last 5 minutes."
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: decimal
              decimalPlaces: 2
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "req/s"
                  query: sum(rate(authorized_calls[5m]))

    inferenceSuccessRate:
      kind: Panel
      spec:
        display:
          name: "‚úÖ Inference Success Rate"
          description: "Model inference success rate: requests that completed successfully / total requests that reached the model. Rate-limited requests (429) are excluded."
        plugin:
          kind: GaugeChart
          spec:
            calculation: last-number
            format:
              unit: percent-decimal
              decimalPlaces: 1
            max: 1
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "Success Rate"
                  query: ((sum(rate(vllm:request_success_total[5m])) / sum(rate(vllm:e2e_request_latency_seconds_count[5m]))) >= 0) OR vector(1)

    activeUsers:
      kind: Panel
      spec:
        display:
          name: "üë• Active Users"
          description: "Unique users with at least one successful request."
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "Users"
                  query: count(count by (user) (authorized_calls))

    p50Latency:
      kind: Panel
      spec:
        display:
          name: "‚è±Ô∏è P50 Response Latency"
          description: "Median (50th percentile) response latency measured at the gateway over a 15m window."
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: milliseconds
              decimalPlaces: 0
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "P50"
                  query: (histogram_quantile(0.5, sum(rate(istio_request_duration_milliseconds_bucket[15m])) by (le)) >= 0) OR vector(0)

    rateLimitRatio:
      kind: Panel
      spec:
        display:
          name: "üö¶ Rate Limit Ratio"
          description: "Percentage of gateway requests rejected by rate limiting (HTTP 429). High values indicate users are exceeding their tier quotas."
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: percent-decimal
              decimalPlaces: 1
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "Rate Limited"
                  query: (sum(limited_calls) / (sum(authorized_calls) + sum(limited_calls))) OR vector(0)

    # =============================================
    # Section: Traffic Analysis (6 panels)
    # =============================================
    tokenRateByModel:
      kind: Panel
      spec:
        display:
          name: "üìà Token Rate by Model"
          description: "Token consumption rate (tokens/s) broken down by model. Shows which models consume the most tokens."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: bottom
              mode: table
            yAxis:
              format:
                unit: decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{model}}"
                  query: sum by (model) (rate(authorized_hits{model!=""}[5m]))

    overallErrorRate:
      kind: Panel
      spec:
        display:
          name: "‚ùå Overall Error Rate"
          description: "Error rates by type. 4xx = client errors excluding 429, 5xx = server errors, Rate Limited = 429 quota exceeded."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: bottom
              mode: table
            yAxis:
              format:
                unit: decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "4xx Errors (excl. 429)"
                  query: sum(rate(istio_requests_total{response_code=~"4..", response_code!="429"}[5m])) OR vector(0)
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "5xx Errors"
                  query: sum(rate(istio_requests_total{response_code=~"5.."}[5m])) OR vector(0)
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "429 Rate Limited"
                  query: sum(rate(limited_calls[5m])) OR vector(0)

    tokenConsumptionByTier:
      kind: Panel
      spec:
        display:
          name: "üìä Token Consumption by Tier"
          description: "Token consumption rate (tokens/s) by tier."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: bottom
              mode: table
            yAxis:
              format:
                unit: decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{tier}}"
                  query: sum by (tier) (rate(authorized_hits[5m]))

    requestVolumeByTier:
      kind: Panel
      spec:
        display:
          name: "üìà Request Volume by Tier"
          description: "Request rate (req/s) by tier."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: bottom
              mode: table
            yAxis:
              format:
                unit: decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{tier}}"
                  query: sum by (tier) (rate(authorized_calls[5m]))

    p95LatencyByService:
      kind: Panel
      spec:
        display:
          name: "‚è±Ô∏è P95 Latency by Service"
          description: "95th percentile latency per backend service. Excludes unknown (404s to non-existent paths)."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: bottom
              mode: table
            yAxis:
              format:
                unit: milliseconds
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{destination_service_name}}"
                  query: histogram_quantile(0.95, sum by (destination_service_name, le) (rate(istio_request_duration_milliseconds_bucket{destination_service_name!="unknown"}[5m])))

    rateLimitViolationsByTier:
      kind: Panel
      spec:
        display:
          name: "üö´ Rate Limit Violations by Tier"
          description: "Rate limit violations (HTTP 429) by tier."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: bottom
              mode: table
            yAxis:
              format:
                unit: decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{tier}}"
                  query: sum by (tier) (rate(limited_calls[5m]))

    # =============================================
    # Section: Error Breakdown (2 panels)
    # =============================================
    rateLimitedRequests:
      kind: Panel
      spec:
        display:
          name: "üö´ Rate Limited Requests"
          description: "Rate of requests that exceeded quota and received HTTP 429."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: bottom
              mode: table
            yAxis:
              format:
                unit: decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "Rate Limited"
                  query: sum(rate(limited_calls[5m]))

    unauthorizedRequests:
      kind: Panel
      spec:
        display:
          name: "üîí Unauthorized Requests"
          description: "Rate of unauthorized (401) requests at the gateway."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: bottom
              mode: table
            yAxis:
              format:
                unit: decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "Unauthorized (401)"
                  query: sum(rate(istio_requests_total{response_code="401"}[5m])) OR vector(0)

    # =============================================
    # Section: Model Metrics (12 panels)
    # =============================================
    requestsRunning:
      kind: Panel
      spec:
        display:
          name: "üîÑ Requests Running"
          description: "Number of inference requests currently being processed by the model."
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "Running"
                  query: sum(vllm:num_requests_running)

    requestsWaiting:
      kind: Panel
      spec:
        display:
          name: "‚è≥ Requests Waiting"
          description: "Number of inference requests waiting in queue. Growing queue indicates model is overloaded."
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "Waiting"
                  query: sum(vllm:num_requests_waiting)

    gpuCacheUsage:
      kind: Panel
      spec:
        display:
          name: "üíæ GPU Cache Usage"
          description: "Percentage of GPU KV-cache in use. High values (>90%) may cause request queuing."
        plugin:
          kind: GaugeChart
          spec:
            calculation: last-number
            format:
              unit: percent-decimal
              decimalPlaces: 1
            max: 1
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "Cache Usage"
                  query: avg(vllm:kv_cache_usage_perc)

    totalModelRequests:
      kind: Panel
      spec:
        display:
          name: "üìä Total Requests"
          description: "Total inference requests processed by the model in the last hour."
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: decimal
              shortValues: true
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "Requests"
                  query: sum(increase(vllm:e2e_request_latency_seconds_count{model_name=~"$model"}[1h]))

    modelQueueDepth:
      kind: Panel
      spec:
        display:
          name: "üìä Model Queue Depth"
          description: "Running and waiting requests per model over time."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: bottom
              mode: table
            yAxis:
              format:
                unit: decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{model_name}} running"
                  query: sum by (model_name) (vllm:num_requests_running{model_name=~"$model"})
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{model_name}} waiting"
                  query: sum by (model_name) (vllm:num_requests_waiting{model_name=~"$model"})

    modelInferenceLatency:
      kind: Panel
      spec:
        display:
          name: "‚è±Ô∏è Model Inference Latency"
          description: "End-to-end model inference latency (P50/P95/P99). Includes queue time + processing time."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: bottom
              mode: table
            yAxis:
              format:
                unit: seconds
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{model_name}} P50"
                  query: histogram_quantile(0.5, sum(rate(vllm:e2e_request_latency_seconds_bucket{model_name=~"$model"}[5m])) by (le, model_name))
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{model_name}} P95"
                  query: histogram_quantile(0.95, sum(rate(vllm:e2e_request_latency_seconds_bucket{model_name=~"$model"}[5m])) by (le, model_name))
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{model_name}} P99"
                  query: histogram_quantile(0.99, sum(rate(vllm:e2e_request_latency_seconds_bucket{model_name=~"$model"}[5m])) by (le, model_name))

    tokensTotal:
      kind: Panel
      spec:
        display:
          name: "üî§ Tokens (1h)"
          description: "Total prompt + generation tokens processed in the last hour across all models."
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: decimal
              shortValues: true
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "Tokens"
                  query: sum(increase(vllm:request_prompt_tokens_sum{model_name=~"$model"}[1h])) + sum(increase(vllm:request_generation_tokens_sum{model_name=~"$model"}[1h]))

    tokenThroughput:
      kind: Panel
      spec:
        display:
          name: "üî§ Token Throughput"
          description: "Token processing rate. Prompt = input tokens, Generation = output tokens."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: right
              mode: table
            yAxis:
              format:
                unit: decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "Prompt tokens/s"
                  query: sum(rate(vllm:request_prompt_tokens_sum{model_name=~"$model"}[5m]))
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "Generation tokens/s"
                  query: sum(rate(vllm:request_generation_tokens_sum{model_name=~"$model"}[5m]))

    promptVsGenerationRatio:
      kind: Panel
      spec:
        display:
          name: "üìä Prompt vs Generation Token Ratio"
          description: "Ratio of prompt (input) tokens to total tokens per model. Values close to 1.0 mean large contexts with little generation."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: bottom
              mode: table
            yAxis:
              format:
                unit: percent-decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{model_name}}"
                  query: (sum by (model_name) (rate(vllm:request_prompt_tokens_sum{model_name=~"$model"}[5m]))) / clamp_min(sum by (model_name) (rate(vllm:request_prompt_tokens_sum{model_name=~"$model"}[5m])) + sum by (model_name) (rate(vllm:request_generation_tokens_sum{model_name=~"$model"}[5m])), 1e-9) and (sum by (model_name) (rate(vllm:request_prompt_tokens_sum{model_name=~"$model"}[5m])) + sum by (model_name) (rate(vllm:request_generation_tokens_sum{model_name=~"$model"}[5m]))) > 0

    queueWaitTime:
      kind: Panel
      spec:
        display:
          name: "‚è≥ Queue Wait Time"
          description: "Time requests spend waiting in the model queue before processing begins (P50/P95/P99)."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: bottom
              mode: table
            yAxis:
              format:
                unit: seconds
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{model_name}} P50"
                  query: histogram_quantile(0.5, sum(rate(vllm:request_queue_time_seconds_bucket{model_name=~"$model"}[5m])) by (le, model_name))
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{model_name}} P95"
                  query: histogram_quantile(0.95, sum(rate(vllm:request_queue_time_seconds_bucket{model_name=~"$model"}[5m])) by (le, model_name))
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{model_name}} P99"
                  query: histogram_quantile(0.99, sum(rate(vllm:request_queue_time_seconds_bucket{model_name=~"$model"}[5m])) by (le, model_name))

    ttft:
      kind: Panel
      spec:
        display:
          name: "‚ö° Time to First Token (TTFT)"
          description: "Time to First Token over time (P50/P95/P99). Critical for streaming user experience."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: bottom
              mode: table
            yAxis:
              format:
                unit: seconds
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{model_name}} P50"
                  query: histogram_quantile(0.5, sum(rate(vllm:time_to_first_token_seconds_bucket{model_name=~"$model"}[5m])) by (le, model_name))
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{model_name}} P95"
                  query: histogram_quantile(0.95, sum(rate(vllm:time_to_first_token_seconds_bucket{model_name=~"$model"}[5m])) by (le, model_name))
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{model_name}} P99"
                  query: histogram_quantile(0.99, sum(rate(vllm:time_to_first_token_seconds_bucket{model_name=~"$model"}[5m])) by (le, model_name))

    itl:
      kind: Panel
      spec:
        display:
          name: "‚ö° Inter-Token Latency (ITL)"
          description: "Inter-Token Latency over time (P50/P95/P99). Affects perceived typing speed during streaming."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: bottom
              mode: table
            yAxis:
              format:
                unit: seconds
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{model_name}} P50"
                  query: histogram_quantile(0.5, sum(rate(vllm:inter_token_latency_seconds_bucket{model_name=~"$model"}[5m])) by (le, model_name))
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{model_name}} P95"
                  query: histogram_quantile(0.95, sum(rate(vllm:inter_token_latency_seconds_bucket{model_name=~"$model"}[5m])) by (le, model_name))
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{model_name}} P99"
                  query: histogram_quantile(0.99, sum(rate(vllm:inter_token_latency_seconds_bucket{model_name=~"$model"}[5m])) by (le, model_name))

    # =============================================
    # Section: Top Users (2 panels)
    # =============================================
    topUsersByTokens:
      kind: Panel
      spec:
        display:
          name: "üèÜ Top 10 Users by Token Usage"
          description: "Top 10 users ranked by total tokens consumed."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: bottom
              mode: table
            yAxis:
              format:
                unit: decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{user}}"
                  query: topk(10, sum by (user) (authorized_hits{user!=""}))

    topUsersByDeclined:
      kind: Panel
      spec:
        display:
          name: "üèÜ Top 10 Users by Declined Requests"
          description: "Top 10 users ranked by rate-limited requests (HTTP 429)."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: bottom
              mode: table
            yAxis:
              format:
                unit: decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{user}}"
                  query: topk(10, sum by (user) (limited_calls{user!=""}))

    # =============================================
    # Section: Detailed Breakdown (2 panels)
    # =============================================
    tokenRateByUser:
      kind: Panel
      spec:
        display:
          name: "üë• Token Rate by User"
          description: "Token consumption rate (tokens/s) broken down by individual user."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: bottom
              mode: table
            yAxis:
              format:
                unit: decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{user}}"
                  query: sum by (user) (rate(authorized_hits[5m]))

    requestVolumeByUserTier:
      kind: Panel
      spec:
        display:
          name: "üìã Request Volume by User & Tier"
          description: "Request count by user and tier. Note: OpenShift Console shows raw labels; native Perses applies the formatted series name."
        plugin:
          kind: TimeSeriesTable
          spec: {}
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{user}} / {{tier}}"
                  query: sum by (user, tier) (authorized_calls{user!=""})

    # =============================================
    # Section: Resource Allocation (1 panel)
    # =============================================
    resourceAllocationTable:
      kind: Panel
      spec:
        display:
          name: "üì¶ Resource Allocation per Model"
          description: "Resource requests/limits for LLM model pods. Note: OpenShift Console shows raw labels; native Perses applies the formatted series name."
        plugin:
          kind: TimeSeriesTable
          spec: {}
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{pod}} - CPU requests"
                  query: max by (pod) (kube_pod_container_resource_requests{namespace=~"$llm_namespace", resource="cpu"})
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{pod}} - CPU limits"
                  query: max by (pod) (kube_pod_container_resource_limits{namespace=~"$llm_namespace", resource="cpu"})
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{pod}} - Memory requests"
                  query: max by (pod) (kube_pod_container_resource_requests{namespace=~"$llm_namespace", resource="memory"})
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{pod}} - Memory limits"
                  query: max by (pod) (kube_pod_container_resource_limits{namespace=~"$llm_namespace", resource="memory"})
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{pod}} - GPUs"
                  query: max by (pod) (kube_pod_container_resource_requests{namespace=~"$llm_namespace", resource=~"nvidia.com/gpu|amd.com/gpu"})

    # =============================================
    # Section: User Tracking (1 panel)
    # =============================================
    tokenUsageAndRateLimitsPerUser:
      kind: Panel
      spec:
        display:
          name: "üë§ Token Usage & Rate Limits per User"
          description: "Per-user metrics. Shows token consumption rate vs rate-limited requests per user over time."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: bottom
              mode: table
            yAxis:
              format:
                unit: decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{user}} (tokens/s)"
                  query: sum by (user) (rate(authorized_hits[5m]))
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{user}} (429 Rate Limited)"
                  query: sum by (user) (rate(limited_calls[5m]))

    # =============================================
    # Section: Per-Tier & Per-Model Breakdown (3 panels)
    # =============================================
    latencyPerTier:
      kind: Panel
      spec:
        display:
          name: "‚è±Ô∏è Latency per Tier (P50 / P95 / P99)"
          description: "P50/P95/P99 latency per access tier. The tier label is added via Istio Telemetry reading the X-MaaS-Tier header."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: bottom
              mode: table
            yAxis:
              format:
                unit: milliseconds
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{tier}} P50"
                  query: histogram_quantile(0.5, sum by (tier, le) (rate(istio_request_duration_milliseconds_bucket{tier!="",tier!="unknown"}[5m])))
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{tier}} P95"
                  query: histogram_quantile(0.95, sum by (tier, le) (rate(istio_request_duration_milliseconds_bucket{tier!="",tier!="unknown"}[5m])))
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{tier}} P99"
                  query: histogram_quantile(0.99, sum by (tier, le) (rate(istio_request_duration_milliseconds_bucket{tier!="",tier!="unknown"}[5m])))

    p95LatencyPerModel:
      kind: Panel
      spec:
        display:
          name: "‚è±Ô∏è P95 Latency per Model"
          description: "P95 latency per model (backend service). Each KServe model gets a dedicated service."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: bottom
              mode: table
            yAxis:
              format:
                unit: milliseconds
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{destination_service_name}}"
                  query: histogram_quantile(0.95, sum by (destination_service_name, le) (rate(istio_request_duration_milliseconds_bucket{destination_service_name!="",destination_service_name!="unknown"}[5m])))

    tokenVolumeByTier:
      kind: Panel
      spec:
        display:
          name: "üìä Token Volume by Tier"
          description: "Token consumption per tier over time. Shows absolute token volume per tier."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: bottom
              mode: table
            visual:
              display: bar
              stack: all
            yAxis:
              format:
                unit: decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{tier}}"
                  query: sum by (tier) (increase(authorized_hits{tier!=""}[5m]))

  # Layout definition
  layouts:
    - kind: Grid
      spec:
        display:
          title: "üè• Component Health"
          collapse:
            open: true
        items:
          - x: 0
            "y": 0
            width: 6
            height: 4
            content:
              "$ref": "#/spec/panels/limitadorHealth"
          - x: 6
            "y": 0
            width: 6
            height: 4
            content:
              "$ref": "#/spec/panels/authorinoHealth"
          - x: 12
            "y": 0
            width: 6
            height: 4
            content:
              "$ref": "#/spec/panels/maasApiPods"
          - x: 18
            "y": 0
            width: 6
            height: 4
            content:
              "$ref": "#/spec/panels/gatewayPods"
          - x: 0
            "y": 4
            width: 6
            height: 6
            content:
              "$ref": "#/spec/panels/firingAlerts"
          - x: 6
            "y": 4
            width: 18
            height: 6
            content:
              "$ref": "#/spec/panels/activeAlertsTable"

    - kind: Grid
      spec:
        display:
          title: "üîê Auth Evaluation"
          collapse:
            open: true
        items:
          - x: 0
            "y": 0
            width: 12
            height: 8
            content:
              "$ref": "#/spec/panels/authEvaluationLatency"
          - x: 12
            "y": 0
            width: 12
            height: 8
            content:
              "$ref": "#/spec/panels/authSuccessDenyRate"

    - kind: Grid
      spec:
        display:
          title: "üìä Key Metrics"
          collapse:
            open: true
        items:
          - x: 0
            "y": 0
            width: 6
            height: 5
            content:
              "$ref": "#/spec/panels/totalTokensConsumed"
          - x: 6
            "y": 0
            width: 6
            height: 5
            content:
              "$ref": "#/spec/panels/totalRequests"
          - x: 12
            "y": 0
            width: 6
            height: 5
            content:
              "$ref": "#/spec/panels/tokenRate"
          - x: 18
            "y": 0
            width: 6
            height: 5
            content:
              "$ref": "#/spec/panels/requestRate"
          - x: 0
            "y": 5
            width: 6
            height: 5
            content:
              "$ref": "#/spec/panels/inferenceSuccessRate"
          - x: 6
            "y": 5
            width: 6
            height: 5
            content:
              "$ref": "#/spec/panels/activeUsers"
          - x: 12
            "y": 5
            width: 6
            height: 5
            content:
              "$ref": "#/spec/panels/p50Latency"
          - x: 18
            "y": 5
            width: 6
            height: 5
            content:
              "$ref": "#/spec/panels/rateLimitRatio"

    - kind: Grid
      spec:
        display:
          title: "üìà Traffic Analysis"
          collapse:
            open: true
        items:
          - x: 0
            "y": 0
            width: 12
            height: 8
            content:
              "$ref": "#/spec/panels/tokenRateByModel"
          - x: 12
            "y": 0
            width: 12
            height: 8
            content:
              "$ref": "#/spec/panels/overallErrorRate"
          - x: 0
            "y": 8
            width: 12
            height: 8
            content:
              "$ref": "#/spec/panels/tokenConsumptionByTier"
          - x: 12
            "y": 8
            width: 12
            height: 8
            content:
              "$ref": "#/spec/panels/requestVolumeByTier"
          - x: 0
            "y": 16
            width: 12
            height: 8
            content:
              "$ref": "#/spec/panels/p95LatencyByService"
          - x: 12
            "y": 16
            width: 12
            height: 8
            content:
              "$ref": "#/spec/panels/rateLimitViolationsByTier"

    - kind: Grid
      spec:
        display:
          title: "‚ùå Error Breakdown"
          collapse:
            open: true
        items:
          - x: 0
            "y": 0
            width: 12
            height: 8
            content:
              "$ref": "#/spec/panels/rateLimitedRequests"
          - x: 12
            "y": 0
            width: 12
            height: 8
            content:
              "$ref": "#/spec/panels/unauthorizedRequests"

    - kind: Grid
      spec:
        display:
          title: "ü§ñ Model Metrics"
          collapse:
            open: true
        items:
          - x: 0
            "y": 0
            width: 6
            height: 5
            content:
              "$ref": "#/spec/panels/requestsRunning"
          - x: 6
            "y": 0
            width: 6
            height: 5
            content:
              "$ref": "#/spec/panels/requestsWaiting"
          - x: 12
            "y": 0
            width: 6
            height: 5
            content:
              "$ref": "#/spec/panels/gpuCacheUsage"
          - x: 18
            "y": 0
            width: 6
            height: 5
            content:
              "$ref": "#/spec/panels/totalModelRequests"
          - x: 0
            "y": 5
            width: 12
            height: 8
            content:
              "$ref": "#/spec/panels/modelQueueDepth"
          - x: 12
            "y": 5
            width: 12
            height: 8
            content:
              "$ref": "#/spec/panels/modelInferenceLatency"
          - x: 0
            "y": 13
            width: 12
            height: 5
            content:
              "$ref": "#/spec/panels/tokensTotal"
          - x: 12
            "y": 13
            width: 12
            height: 5
            content:
              "$ref": "#/spec/panels/tokenThroughput"
          - x: 0
            "y": 18
            width: 12
            height: 8
            content:
              "$ref": "#/spec/panels/promptVsGenerationRatio"
          - x: 12
            "y": 18
            width: 12
            height: 8
            content:
              "$ref": "#/spec/panels/queueWaitTime"
          - x: 0
            "y": 26
            width: 12
            height: 8
            content:
              "$ref": "#/spec/panels/ttft"
          - x: 12
            "y": 26
            width: 12
            height: 8
            content:
              "$ref": "#/spec/panels/itl"

    - kind: Grid
      spec:
        display:
          title: "üèÜ Top Users"
          collapse:
            open: true
        items:
          - x: 0
            "y": 0
            width: 24
            height: 7
            content:
              "$ref": "#/spec/panels/topUsersByTokens"
          - x: 0
            "y": 7
            width: 24
            height: 7
            content:
              "$ref": "#/spec/panels/topUsersByDeclined"

    - kind: Grid
      spec:
        display:
          title: "üìã Detailed Breakdown"
          collapse:
            open: true
        items:
          - x: 0
            "y": 0
            width: 24
            height: 8
            content:
              "$ref": "#/spec/panels/tokenRateByUser"
          - x: 0
            "y": 8
            width: 24
            height: 8
            content:
              "$ref": "#/spec/panels/requestVolumeByUserTier"

    - kind: Grid
      spec:
        display:
          title: "üì¶ Resource Allocation"
          collapse:
            open: true
        items:
          - x: 0
            "y": 0
            width: 24
            height: 8
            content:
              "$ref": "#/spec/panels/resourceAllocationTable"

    - kind: Grid
      spec:
        display:
          title: "üë§ User Tracking"
          collapse:
            open: true
        items:
          - x: 0
            "y": 0
            width: 24
            height: 8
            content:
              "$ref": "#/spec/panels/tokenUsageAndRateLimitsPerUser"

    - kind: Grid
      spec:
        display:
          title: "üìä Per-Tier & Per-Model Breakdown"
          collapse:
            open: true
        items:
          - x: 0
            "y": 0
            width: 8
            height: 8
            content:
              "$ref": "#/spec/panels/latencyPerTier"
          - x: 8
            "y": 0
            width: 8
            height: 8
            content:
              "$ref": "#/spec/panels/p95LatencyPerModel"
          - x: 16
            "y": 0
            width: 8
            height: 8
            content:
              "$ref": "#/spec/panels/tokenVolumeByTier"
