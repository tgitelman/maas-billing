# Perses Dashboard: AI Engineer Dashboard
# GENERATED FROM Grafana source: deployment/components/observability/grafana/dashboards/dashboard-ai-engineer.yaml
# Every panel and PromQL query matches the Grafana version except:
#   - Grafana's $__range is replaced with [1h] (Perses does not support $__range)
apiVersion: perses.dev/v1alpha1
kind: PersesDashboard
metadata:
  name: ai-engineer-dashboard
  labels:
    app: perses
    app.kubernetes.io/part-of: maas-observability
spec:
  display:
    name: "AI Engineer Dashboard"
    description: "API usage metrics for AI Engineers using MaaS platform"
  duration: 1h

  variables:
    - kind: ListVariable
      spec:
        name: user
        display:
          name: "API Key / User"
        allowMultiple: false
        allowAllValue: true
        defaultValue: "$__all"
        plugin:
          kind: PrometheusLabelValuesVariable
          spec:
            labelName: user
            matchers:
              - authorized_hits

  panels:
    # =============================================
    # Section: My Usage Summary (6 panels)
    # =============================================
    myTotalTokens:
      kind: Panel
      spec:
        display:
          name: "üìä Total Tokens"
          description: "Total API tokens you have consumed that were successfully authorized."
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: decimal
              shortValues: true
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "Tokens"
                  query: sum(authorized_hits{user=~"^$user$"})

    myTotalRequests:
      kind: Panel
      spec:
        display:
          name: "üìä Total Requests"
          description: "Total API requests you have made that were successfully authorized."
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: decimal
              shortValues: true
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "Requests"
                  query: sum(authorized_calls{user=~"^$user$"})

    tokenRate:
      kind: Panel
      spec:
        display:
          name: "‚ö° Token Rate"
          description: "Your current token consumption rate (tokens per second) averaged over the last 5 minutes."
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: decimal
              decimalPlaces: 2
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "tokens/s"
                  query: sum(rate(authorized_hits{user=~"^$user$"}[5m]))

    requestRate:
      kind: Panel
      spec:
        display:
          name: "‚ö° Request Rate"
          description: "Your current request rate (requests per second) averaged over the last 5 minutes."
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: decimal
              decimalPlaces: 2
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "req/s"
                  query: sum(rate(authorized_calls{user=~"^$user$"}[5m]))

    rateLimitRatio:
      kind: Panel
      spec:
        display:
          name: "üö¶ Rate Limit Ratio"
          description: "Percentage of your requests rejected by rate limiting (HTTP 429). High values indicate you are exceeding your tier quota."
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: percent-decimal
              decimalPlaces: 1
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "Rate Limited"
                  query: (sum(limited_calls{user=~"^$user$"}) / (sum(authorized_calls{user=~"^$user$"}) + sum(limited_calls{user=~"^$user$"}))) OR vector(0)

    inferenceSuccessRate:
      kind: Panel
      spec:
        display:
          name: "‚úÖ Inference Success Rate"
          description: "Model inference success rate: percentage of requests that reached the model and completed successfully. Platform-wide health indicator."
        plugin:
          kind: GaugeChart
          spec:
            calculation: last-number
            format:
              unit: percent-decimal
              decimalPlaces: 1
            max: 1
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "Success Rate"
                  query: ((sum(rate(vllm:request_success_total[5m])) / sum(rate(vllm:e2e_request_latency_seconds_count[5m]))) >= 0) OR vector(1)

    # =============================================
    # Section: Usage Trends (2 panels)
    # =============================================
    tokenUsageByModel:
      kind: Panel
      spec:
        display:
          name: "üìà Token Usage by Model"
          description: "Your token consumption broken down by model. Shows which models consume the most tokens."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: bottom
              mode: table
            yAxis:
              format:
                unit: decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{model}}"
                  query: sum by (model) (authorized_hits{user=~"^$user$", model!=""})

    usageTrends:
      kind: Panel
      spec:
        display:
          name: "üìä Usage Trends (Tokens vs Rate Limited Requests)"
          description: "Token consumption rate (authorized) and rate-limited request rate over time."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: bottom
              mode: table
            yAxis:
              format:
                unit: decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "Tokens (authorized)"
                  query: sum(rate(authorized_hits{user=~"^$user$"}[5m]))
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "Requests (rate limited)"
                  query: sum(rate(limited_calls{user=~"^$user$"}[5m]))

    # =============================================
    # Section: Hourly Usage Patterns (1 panel)
    # =============================================
    hourlyTokenUsageByModel:
      kind: Panel
      spec:
        display:
          name: "‚è∞ Hourly Token Usage by Model"
          description: "Hourly token consumption broken down by model."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: bottom
              mode: table
            visual:
              display: bar
              stack: all
            yAxis:
              format:
                unit: decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{model}}"
                  query: sum by (model) (increase(authorized_hits{user=~"^$user$", model!=""}[1h]))

    # =============================================
    # Section: Detailed Analysis (3 panels)
    # =============================================
    tokenVolumeByModel:
      kind: Panel
      spec:
        display:
          name: "üìä Token Volume by Model (Hourly)"
          description: "Token volume per model in 1-hour windows. Note: Grafana uses $__range (adapts to dashboard time picker); Perses does not support $__range, so a fixed 1h window is used."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: bottom
              mode: table
            visual:
              display: bar
            yAxis:
              format:
                unit: decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{model}}"
                  query: sum by (model) (increase(authorized_hits{user=~"^$user$", model!=""}[1h]))

    rateLimitedByTier:
      kind: Panel
      spec:
        display:
          name: "‚ùå Rate Limited by Tier (Hourly)"
          description: "Rate-limited requests by tier in 1-hour windows. Note: Grafana uses $__range (adapts to dashboard time picker); Perses does not support $__range, so a fixed 1h window is used."
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              position: bottom
              mode: table
            yAxis:
              format:
                unit: decimal
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{tier}} (limited)"
                  query: sum by (tier) (increase(limited_calls{user=~"^$user$", tier!=""}[1h]))

    usageSummaryByModelTier:
      kind: Panel
      spec:
        display:
          name: "üîç My Usage Summary by Model & Tier"
          description: "Token consumption by model and tier. Note: OpenShift Console shows raw labels; native Perses applies the formatted series name."
        plugin:
          kind: TimeSeriesTable
          spec: {}
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  seriesNameFormat: "{{model}} / {{tier}}"
                  query: sum by (model, tier) (authorized_hits{user=~"^$user$", model!=""})

  # Layout definition
  layouts:
    - kind: Grid
      spec:
        display:
          title: "üìä My Usage Summary"
          collapse:
            open: true
        items:
          - x: 0
            "y": 0
            width: 4
            height: 5
            content:
              "$ref": "#/spec/panels/myTotalTokens"
          - x: 4
            "y": 0
            width: 4
            height: 5
            content:
              "$ref": "#/spec/panels/myTotalRequests"
          - x: 8
            "y": 0
            width: 4
            height: 5
            content:
              "$ref": "#/spec/panels/tokenRate"
          - x: 12
            "y": 0
            width: 4
            height: 5
            content:
              "$ref": "#/spec/panels/requestRate"
          - x: 16
            "y": 0
            width: 4
            height: 5
            content:
              "$ref": "#/spec/panels/rateLimitRatio"
          - x: 20
            "y": 0
            width: 4
            height: 5
            content:
              "$ref": "#/spec/panels/inferenceSuccessRate"

    - kind: Grid
      spec:
        display:
          title: "üìà Usage Trends"
          collapse:
            open: true
        items:
          - x: 0
            "y": 0
            width: 12
            height: 8
            content:
              "$ref": "#/spec/panels/tokenUsageByModel"
          - x: 12
            "y": 0
            width: 12
            height: 8
            content:
              "$ref": "#/spec/panels/usageTrends"

    - kind: Grid
      spec:
        display:
          title: "‚è∞ Hourly Usage Patterns"
          collapse:
            open: true
        items:
          - x: 0
            "y": 0
            width: 24
            height: 8
            content:
              "$ref": "#/spec/panels/hourlyTokenUsageByModel"

    - kind: Grid
      spec:
        display:
          title: "üîç Detailed Analysis"
          collapse:
            open: true
        items:
          - x: 0
            "y": 0
            width: 24
            height: 8
            content:
              "$ref": "#/spec/panels/tokenVolumeByModel"
          - x: 0
            "y": 8
            width: 24
            height: 8
            content:
              "$ref": "#/spec/panels/rateLimitedByTier"

    - kind: Grid
      spec:
        display:
          title: "üìã Usage Summary"
          collapse:
            open: true
        items:
          - x: 0
            "y": 0
            width: 24
            height: 6
            content:
              "$ref": "#/spec/panels/usageSummaryByModelTier"
