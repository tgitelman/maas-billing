# Expected Metrics Configuration for MaaS Observability Tests
# ==========================================================
#
# This file defines the expected metrics that should be available after
# deploying the MaaS observability stack. Tests will FAIL with informative
# messages if:
#   - A metric is missing (not found in the endpoint)
#   - A metric is missing expected labels
#   - A Kubernetes resource (TelemetryPolicy, Telemetry) is not deployed
#
# Update this file when:
#   - Adding new metrics to the observability stack
#   - Changing metric names or labels
#   - Adding new observability components

# Kubernetes resources that must exist for observability
resources:
  telemetry_policy:
    name: "user-group"
    namespace: "openshift-ingress"
    kind: "TelemetryPolicy"
    api_group: "extensions.kuadrant.io/v1alpha1"
    # Expected status condition
    expected_condition:
      type: "Enforced"
      status: "True"

  istio_telemetry:
    name: "latency-per-user"
    namespace: "openshift-ingress"
    kind: "Telemetry"
    api_group: "telemetry.istio.io/v1"

  limitador_servicemonitor:
    name: "limitador-metrics"
    namespace: "kuadrant-system"
    kind: "ServiceMonitor"
    api_group: "monitoring.coreos.com/v1"

# Metrics exposed by Limitador (rate limiting service)
# These metrics are enriched with user/tier/model labels via TelemetryPolicy
#
# Reference: docs/content/advanced-administration/observability.md
limitador:
  # How to access metrics (for tests)
  access:
    service: "limitador-limitador"
    namespace: "kuadrant-system"
    port: 8080
    path: "/metrics"

  # Token Consumption Metrics (from observability.md "Key Metrics Reference")
  # These are the primary metrics for billing and usage tracking
  token_metrics:
    - name: "authorized_hits"
      type: "counter"
      description: "Total tokens consumed (from usage.total_tokens)"
      labels:
        required:
          - "user"
          - "tier"
          - "model"

    - name: "authorized_calls"
      type: "counter"
      description: "Total requests allowed"
      labels:
        required:
          - "user"
          - "tier"
          - "model"

    - name: "limited_calls"
      type: "counter"
      description: "Total requests rate-limited"
      labels:
        required:
          - "user"
          - "tier"
          - "model"

  # Rate Limiting Metrics (from observability.md "Limitador Metrics")
  ratelimit_metrics:
    - name: "limitador_ratelimit_requests_total"
      type: "counter"
      description: "Total number of rate limit requests"

    - name: "limitador_ratelimit_allowed_total"
      type: "counter"
      description: "Number of requests allowed"

    - name: "limitador_ratelimit_denied_total"
      type: "counter"
      description: "Number of requests denied"

    - name: "limitador_ratelimit_errors_total"
      type: "counter"
      description: "Number of rate limiting errors"

  # Performance Metrics (from observability.md)
  performance_metrics:
    - name: "limitador_ratelimit_duration_seconds"
      type: "histogram"
      description: "Duration of rate limit checks"

    - name: "limitador_ratelimit_active_connections"
      type: "gauge"
      description: "Number of active connections"

    - name: "limitador_ratelimit_cache_hits_total"
      type: "counter"
      description: "Cache hit rate"

    - name: "limitador_ratelimit_cache_misses_total"
      type: "counter"
      description: "Cache miss rate"

  # Tier-Based Metrics (from observability.md)
  tier_metrics:
    - name: "limitador_ratelimit_tier_requests_total"
      type: "counter"
      description: "Requests per tier"

    - name: "limitador_ratelimit_tier_allowed_total"
      type: "counter"
      description: "Allowed requests per tier"

    - name: "limitador_ratelimit_tier_denied_total"
      type: "counter"
      description: "Denied requests per tier"

  # Health Metrics
  health_metrics:
    - name: "limitador_up"
      type: "gauge"
      description: "Limitador is running"

# Latency Metrics (from observability.md "Key Metrics Reference")
# Reference: docs/content/advanced-administration/observability.md
latency_metrics:
  # Istio Gateway metrics
  istio_gateway:
    access:
      method: "prometheus_query"
      # Direct: service istio-gateway in openshift-ingress, port 15090, path /stats/prometheus

    metrics:
      - name: "istio_request_duration_milliseconds_bucket"
        type: "histogram"
        description: "Gateway-level latency histogram"
        labels:
          required:
            - "destination_service_name"
            - "user"  # Added by istio-telemetry.yaml from X-MaaS-Username header
          optional:
            - "response_code"
            - "le"  # histogram bucket boundary

  # vLLM Model metrics
  vllm:
    metrics:
      - name: "vllm:e2e_request_latency_seconds"
        type: "histogram"
        description: "Model inference latency"
        labels:
          required:
            - "model_name"

# Labels injected by TelemetryPolicy (for documentation)
# These are the labels that TelemetryPolicy extracts and adds to Limitador metrics
telemetry_policy_labels:
  user:
    source: "auth.identity.userid"
    description: "User identifier extracted from authenticated identity"

  tier:
    source: "auth.identity.tier"
    description: "User's access tier (free, premium, enterprise)"

  model:
    source: "responseBodyJSON('/model')"
    description: "Model name extracted from the response body"

# Labels injected by Istio Telemetry resource
istio_telemetry_labels:
  user:
    source: "request.headers['x-maas-username']"
    description: "Username from X-MaaS-Username header (injected by AuthPolicy)"
