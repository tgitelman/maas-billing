# Perses Dashboard: AI Engineer Dashboard
# Converted from Grafana ai-engineer-dashboard.json
apiVersion: perses.dev/v1alpha1
kind: PersesDashboard
metadata:
  name: ai-engineer-dashboard
  labels:
    app: perses
    app.kubernetes.io/part-of: maas-observability
spec:
  instanceSelector:
    matchLabels:
      app: perses
  
  dashboard:
    kind: Dashboard
    metadata:
      name: ai-engineer
      project: maas
    spec:
      display:
        name: "üî∑ AI Engineer Dashboard"
      
      # Dashboard refresh interval
      duration: 1h
      refreshInterval: 30s
      
      # Variables (template variables for filtering)
      variables:
        - kind: ListVariable
          spec:
            name: datasource
            display:
              name: Datasource
              hidden: false
            defaultValue: Prometheus
            allowAllValue: false
            allowMultiple: false
            plugin:
              kind: PrometheusDatasourceVariable
              spec: {}
        
        - kind: ListVariable
          spec:
            name: user
            display:
              name: "API Key / User"
              hidden: false
            defaultValue: "$__all"
            allowAllValue: true
            allowMultiple: false
            plugin:
              kind: PrometheusLabelValuesVariable
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: "$datasource"
                labelName: user
                matchers:
                  - authorized_hits
      
      # Dashboard layout with panels
      layouts:
        - kind: Grid
          spec:
            display:
              title: "üìä My Usage Summary"
              collapse:
                open: true
            items:
              # Row 1: Stats
              - x: 0
                y: 0
                width: 6
                height: 5
                content:
                  $ref: "#/spec/panels/total_requests"
              - x: 6
                y: 0
                width: 6
                height: 5
                content:
                  $ref: "#/spec/panels/current_rate"
              - x: 12
                y: 0
                width: 6
                height: 5
                content:
                  $ref: "#/spec/panels/rate_limited"
              - x: 18
                y: 0
                width: 6
                height: 5
                content:
                  $ref: "#/spec/panels/success_rate"
        
        - kind: Grid
          spec:
            display:
              title: "üìà Usage Trends"
              collapse:
                open: true
            items:
              - x: 0
                y: 0
                width: 12
                height: 8
                content:
                  $ref: "#/spec/panels/usage_by_model"
              - x: 12
                y: 0
                width: 12
                height: 8
                content:
                  $ref: "#/spec/panels/request_trends"
        
        - kind: Grid
          spec:
            display:
              title: "‚è∞ Hourly Usage Patterns"
              collapse:
                open: true
            items:
              - x: 0
                y: 0
                width: 24
                height: 8
                content:
                  $ref: "#/spec/panels/hourly_usage"
        
        - kind: Grid
          spec:
            display:
              title: "üîç Detailed Analysis"
              collapse:
                open: true
            items:
              - x: 0
                y: 0
                width: 12
                height: 8
                content:
                  $ref: "#/spec/panels/volume_by_model"
              - x: 12
                y: 0
                width: 12
                height: 8
                content:
                  $ref: "#/spec/panels/rate_limited_by_model"
              - x: 0
                y: 8
                width: 24
                height: 6
                content:
                  $ref: "#/spec/panels/usage_summary_table"
      
      # Panel definitions
      panels:
        total_requests:
          kind: Panel
          spec:
            display:
              name: "üìä My Total Requests"
              description: "Total API requests you have made that were successfully authorized."
            plugin:
              kind: StatChart
              spec:
                calculation: last
                format:
                  unit: short
                sparkline: {}
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'sum(authorized_hits{user=~"^$user$"})'
        
        current_rate:
          kind: Panel
          spec:
            display:
              name: "‚ö° Current Rate (5m avg)"
              description: "Your current request rate (requests per second) averaged over the last 5 minutes."
            plugin:
              kind: StatChart
              spec:
                calculation: last
                format:
                  unit: ops
                sparkline: {}
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'sum(rate(authorized_hits{user=~"^$user$"}[5m]))'
        
        rate_limited:
          kind: Panel
          spec:
            display:
              name: "‚ùå Rate Limited Requests"
              description: "Total requests that were rejected due to rate limiting."
            plugin:
              kind: StatChart
              spec:
                calculation: last
                format:
                  unit: short
                thresholds:
                  steps:
                    - value: 0
                      color: green
                    - value: 1
                      color: yellow
                    - value: 10
                      color: red
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'sum(limited_calls{user=~"^$user$"}) OR vector(0)'
        
        success_rate:
          kind: Panel
          spec:
            display:
              name: "‚úÖ My Success Rate"
              description: "Percentage of your requests that were successful."
            plugin:
              kind: GaugeChart
              spec:
                calculation: last
                format:
                  unit: percent
                thresholds:
                  steps:
                    - value: 0
                      color: red
                    - value: 90
                      color: yellow
                    - value: 95
                      color: green
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: '(sum(authorized_hits{user=~"^$user$"}) / (sum(authorized_hits{user=~"^$user$"}) + sum(limited_calls{user=~"^$user$"}))) OR vector(1)'
        
        usage_by_model:
          kind: Panel
          spec:
            display:
              name: "üìà Usage by Model"
              description: "Your request count broken down by model."
            plugin:
              kind: TimeSeriesChart
              spec:
                legend:
                  position: bottom
                  mode: table
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'sum by (model) (authorized_hits{user=~"^$user$"})'
                      seriesNameFormat: "{{model}}"
        
        request_trends:
          kind: Panel
          spec:
            display:
              name: "üìä Request Trends (Success vs Rate Limited)"
              description: "Your request rate over time, showing successful vs rate-limited requests."
            plugin:
              kind: TimeSeriesChart
              spec:
                legend:
                  position: bottom
                  mode: table
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'sum(rate(authorized_hits{user=~"^$user$"}[5m]))'
                      seriesNameFormat: "Authorized"
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'sum(rate(limited_calls{user=~"^$user$"}[5m]))'
                      seriesNameFormat: "Rate Limited"
        
        hourly_usage:
          kind: Panel
          spec:
            display:
              name: "‚è∞ Hourly Usage by Model"
            plugin:
              kind: TimeSeriesChart
              spec:
                legend:
                  position: bottom
                  mode: table
                visual:
                  display: bar
                  stack: all
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'sum by (model) (increase(authorized_hits{user=~"^$user$"}[1h]))'
                      seriesNameFormat: "{{model}}"
        
        volume_by_model:
          kind: Panel
          spec:
            display:
              name: "üìä Request Volume by Model (Selected Range)"
            plugin:
              kind: TimeSeriesChart
              spec:
                legend:
                  position: bottom
                  mode: table
                visual:
                  display: bar
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'sum by (model) (increase(authorized_hits{user=~"^$user$"}[$__range]))'
                      seriesNameFormat: "{{model}}"
        
        rate_limited_by_model:
          kind: Panel
          spec:
            display:
              name: "‚ùå Rate Limited by Model (Selected Range)"
            plugin:
              kind: TimeSeriesChart
              spec:
                legend:
                  position: bottom
                  mode: table
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'sum by (model) (increase(limited_calls{user=~"^$user$"}[$__range]))'
                      seriesNameFormat: "{{model}} (limited)"
        
        usage_summary_table:
          kind: Panel
          spec:
            display:
              name: "üîç My Usage Summary by Model & Tier"
            plugin:
              kind: Table
              spec:
                columnSettings:
                  - name: model
                    header: "ü§ñ Model"
                  - name: tier
                    header: "üè∑Ô∏è Tier"
                  - name: Value
                    header: "üìä Hits"
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'sum by (model, tier) (authorized_hits{user=~"^$user$"})'

