# Perses Dashboard: Platform Admin Dashboard
# Converted from Grafana platform-admin-dashboard.json
apiVersion: perses.dev/v1alpha1
kind: PersesDashboard
metadata:
  name: platform-admin-dashboard
  labels:
    app: perses
    app.kubernetes.io/part-of: maas-observability
spec:
  instanceSelector:
    matchLabels:
      app: perses
  
  dashboard:
    kind: Dashboard
    metadata:
      name: platform-admin
      project: maas
    spec:
      display:
        name: "üî∑ Platform Admin Dashboard"
      
      duration: 1h
      refreshInterval: 30s
      
      # Variables
      variables:
        - kind: ListVariable
          spec:
            name: datasource
            display:
              name: Datasource
              hidden: false
            defaultValue: Prometheus
            allowAllValue: false
            allowMultiple: false
            plugin:
              kind: PrometheusDatasourceVariable
              spec: {}
        
        - kind: ListVariable
          spec:
            name: maas_namespace
            display:
              name: "MaaS Namespace"
              hidden: false
            defaultValue: "$__all"
            allowAllValue: true
            allowMultiple: false
            plugin:
              kind: PrometheusLabelValuesVariable
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: "$datasource"
                labelName: namespace
                matchers:
                  - 'kube_pod_info{pod=~"maas-api.*"}'
        
        - kind: ListVariable
          spec:
            name: model
            display:
              name: "Model"
              hidden: false
            defaultValue: "$__all"
            allowAllValue: true
            allowMultiple: true
            plugin:
              kind: PrometheusLabelValuesVariable
              spec:
                datasource:
                  kind: PrometheusDatasource
                  name: "$datasource"
                labelName: model_name
                matchers:
                  - vllm:num_requests_running
      
      # Layouts
      layouts:
        - kind: Grid
          spec:
            display:
              title: "üè• Component Health"
              collapse:
                open: true
            items:
              - x: 0
                y: 0
                width: 6
                height: 4
                content:
                  $ref: "#/spec/panels/limitador_health"
              - x: 6
                y: 0
                width: 6
                height: 4
                content:
                  $ref: "#/spec/panels/authorino_health"
              - x: 12
                y: 0
                width: 6
                height: 4
                content:
                  $ref: "#/spec/panels/maas_api_health"
              - x: 18
                y: 0
                width: 6
                height: 4
                content:
                  $ref: "#/spec/panels/gateway_health"
              - x: 0
                y: 4
                width: 6
                height: 6
                content:
                  $ref: "#/spec/panels/firing_alerts"
              - x: 6
                y: 4
                width: 18
                height: 6
                content:
                  $ref: "#/spec/panels/active_alerts_table"
        
        - kind: Grid
          spec:
            display:
              title: "üìä Key Metrics"
              collapse:
                open: true
            items:
              - x: 0
                y: 0
                width: 5
                height: 5
                content:
                  $ref: "#/spec/panels/total_authorized_hits"
              - x: 5
                y: 0
                width: 5
                height: 5
                content:
                  $ref: "#/spec/panels/current_rate"
              - x: 10
                y: 0
                width: 5
                height: 5
                content:
                  $ref: "#/spec/panels/success_rate"
              - x: 15
                y: 0
                width: 4
                height: 5
                content:
                  $ref: "#/spec/panels/active_users"
              - x: 19
                y: 0
                width: 5
                height: 5
                content:
                  $ref: "#/spec/panels/p50_latency"
        
        - kind: Grid
          spec:
            display:
              title: "üìà Traffic Analysis"
              collapse:
                open: true
            items:
              - x: 0
                y: 0
                width: 12
                height: 8
                content:
                  $ref: "#/spec/panels/request_rate_by_model"
              - x: 12
                y: 0
                width: 12
                height: 8
                content:
                  $ref: "#/spec/panels/error_rate"
              - x: 0
                y: 8
                width: 12
                height: 8
                content:
                  $ref: "#/spec/panels/request_rate_by_tier"
              - x: 12
                y: 8
                width: 12
                height: 8
                content:
                  $ref: "#/spec/panels/p95_latency_by_service"
        
        - kind: Grid
          spec:
            display:
              title: "üèÜ Top Users"
              collapse:
                open: true
            items:
              - x: 0
                y: 0
                width: 24
                height: 7
                content:
                  $ref: "#/spec/panels/top_users_table"
        
        - kind: Grid
          spec:
            display:
              title: "üìã Detailed Breakdown"
              collapse:
                open: true
            items:
              - x: 0
                y: 0
                width: 24
                height: 8
                content:
                  $ref: "#/spec/panels/request_rate_by_user"
              - x: 0
                y: 8
                width: 24
                height: 8
                content:
                  $ref: "#/spec/panels/volume_by_user_model_tier"
        
        - kind: Grid
          spec:
            display:
              title: "ü§ñ Model Metrics"
              collapse:
                open: true
            items:
              - x: 0
                y: 0
                width: 6
                height: 5
                content:
                  $ref: "#/spec/panels/requests_running"
              - x: 6
                y: 0
                width: 6
                height: 5
                content:
                  $ref: "#/spec/panels/requests_waiting"
              - x: 12
                y: 0
                width: 6
                height: 5
                content:
                  $ref: "#/spec/panels/gpu_cache_usage"
              - x: 18
                y: 0
                width: 6
                height: 5
                content:
                  $ref: "#/spec/panels/total_model_requests"
              - x: 0
                y: 5
                width: 12
                height: 8
                content:
                  $ref: "#/spec/panels/model_queue_depth"
              - x: 12
                y: 5
                width: 12
                height: 8
                content:
                  $ref: "#/spec/panels/model_latency"
      
      # Panel definitions
      panels:
        limitador_health:
          kind: Panel
          spec:
            display:
              name: "üíö Limitador"
            plugin:
              kind: StatChart
              spec:
                calculation: last
                thresholds:
                  steps:
                    - value: 0
                      color: red
                    - value: 1
                      color: green
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'limitador_up'
        
        authorino_health:
          kind: Panel
          spec:
            display:
              name: "üîê Authorino"
            plugin:
              kind: StatChart
              spec:
                calculation: last
                thresholds:
                  steps:
                    - value: 0
                      color: red
                    - value: 1
                      color: green
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'count(kube_pod_status_phase{namespace="kuadrant-system", pod=~"authorino.*", phase="Running"}) OR vector(0)'
        
        maas_api_health:
          kind: Panel
          spec:
            display:
              name: "üåê MaaS API Pods"
            plugin:
              kind: StatChart
              spec:
                calculation: last
                thresholds:
                  steps:
                    - value: 0
                      color: red
                    - value: 1
                      color: green
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'count(kube_pod_status_phase{namespace=~"$maas_namespace", pod=~"maas-api.*", phase="Running"} == 1) OR on() vector(0)'
        
        gateway_health:
          kind: Panel
          spec:
            display:
              name: "üö™ Gateway Pods"
            plugin:
              kind: StatChart
              spec:
                calculation: last
                thresholds:
                  steps:
                    - value: 0
                      color: red
                    - value: 1
                      color: green
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'count(kube_pod_status_phase{namespace="openshift-ingress", pod=~"maas-default-gateway.*", phase="Running"} == 1) OR on() vector(0)'
        
        firing_alerts:
          kind: Panel
          spec:
            display:
              name: "üö® Firing Alerts"
            plugin:
              kind: StatChart
              spec:
                calculation: last
                thresholds:
                  steps:
                    - value: 0
                      color: green
                    - value: 1
                      color: yellow
                    - value: 3
                      color: red
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'count(ALERTS{alertstate="firing", alertname!="Watchdog", namespace=~"llm|kuadrant-system|maas-api|envoy-gateway-system"}) OR vector(0)'
        
        active_alerts_table:
          kind: Panel
          spec:
            display:
              name: "üìã Active Alerts"
            plugin:
              kind: Table
              spec:
                columnSettings:
                  - name: alertname
                    header: "Alert"
                  - name: severity
                    header: "Severity"
                  - name: namespace
                    header: "Namespace"
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'ALERTS{alertstate="firing", alertname!="Watchdog", namespace=~"llm|kuadrant-system|maas-api|envoy-gateway-system"}'
        
        total_authorized_hits:
          kind: Panel
          spec:
            display:
              name: "üìä Total Authorized Hits"
            plugin:
              kind: StatChart
              spec:
                calculation: last
                format:
                  unit: short
                sparkline: {}
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'sum(authorized_hits)'
        
        current_rate:
          kind: Panel
          spec:
            display:
              name: "‚ö° Current Rate (5m avg)"
            plugin:
              kind: StatChart
              spec:
                calculation: last
                format:
                  unit: ops
                sparkline: {}
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'sum(rate(authorized_hits[5m]))'
        
        success_rate:
          kind: Panel
          spec:
            display:
              name: "‚úÖ Success Rate"
            plugin:
              kind: StatChart
              spec:
                calculation: last
                format:
                  unit: percent
                thresholds:
                  steps:
                    - value: 0
                      color: red
                    - value: 90
                      color: yellow
                    - value: 95
                      color: green
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'sum(authorized_hits) / (sum(authorized_hits) + sum(limited_calls))'
        
        active_users:
          kind: Panel
          spec:
            display:
              name: "üë• Active Users"
            plugin:
              kind: StatChart
              spec:
                calculation: last
                format:
                  unit: short
                sparkline: {}
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'count(count by (user) (authorized_hits))'
        
        p50_latency:
          kind: Panel
          spec:
            display:
              name: "‚è±Ô∏è P50 Response Latency"
            plugin:
              kind: StatChart
              spec:
                calculation: last
                format:
                  unit: milliseconds
                thresholds:
                  steps:
                    - value: 0
                      color: green
                    - value: 100
                      color: yellow
                    - value: 500
                      color: red
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'histogram_quantile(0.5, sum(rate(istio_request_duration_milliseconds_bucket[5m])) by (le))'
        
        request_rate_by_model:
          kind: Panel
          spec:
            display:
              name: "üìà Request Rate by Model"
            plugin:
              kind: TimeSeriesChart
              spec:
                legend:
                  position: bottom
                  mode: table
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'sum by (model) (rate(authorized_hits[5m]))'
                      seriesNameFormat: "{{model}}"
        
        error_rate:
          kind: Panel
          spec:
            display:
              name: "‚ùå Overall Error Rate"
            plugin:
              kind: TimeSeriesChart
              spec:
                legend:
                  position: bottom
                  mode: table
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'sum(rate(istio_requests_total{response_code=~"4.."}[5m])) OR vector(0)'
                      seriesNameFormat: "4xx Errors"
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'sum(rate(istio_requests_total{response_code=~"5.."}[5m])) OR vector(0)'
                      seriesNameFormat: "5xx Errors"
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'sum(rate(limited_calls[5m])) OR vector(0)'
                      seriesNameFormat: "Rate Limited"
        
        request_rate_by_tier:
          kind: Panel
          spec:
            display:
              name: "üìä Request Rate by Tier"
            plugin:
              kind: TimeSeriesChart
              spec:
                legend:
                  position: bottom
                  mode: table
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'sum by (tier) (rate(authorized_hits[5m]))'
                      seriesNameFormat: "{{tier}}"
        
        p95_latency_by_service:
          kind: Panel
          spec:
            display:
              name: "‚è±Ô∏è P95 Latency by Service"
            plugin:
              kind: TimeSeriesChart
              spec:
                legend:
                  position: bottom
                  mode: table
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'histogram_quantile(0.95, sum by (destination_service_name, le) (rate(istio_request_duration_milliseconds_bucket[5m])))'
                      seriesNameFormat: "{{destination_service_name}}"
        
        top_users_table:
          kind: Panel
          spec:
            display:
              name: "üèÜ Top 10 Users by Hits"
            plugin:
              kind: Table
              spec:
                columnSettings:
                  - name: user
                    header: "üë§ User"
                  - name: Value
                    header: "üìä Hits"
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'topk(10, sum by (user) (authorized_hits))'
        
        request_rate_by_user:
          kind: Panel
          spec:
            display:
              name: "üë• Request Rate by User"
            plugin:
              kind: TimeSeriesChart
              spec:
                legend:
                  position: bottom
                  mode: table
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'sum by (user) (rate(authorized_hits[5m]))'
                      seriesNameFormat: "{{user}}"
        
        volume_by_user_model_tier:
          kind: Panel
          spec:
            display:
              name: "üìã Request Volume by User, Model & Tier"
            plugin:
              kind: Table
              spec:
                columnSettings:
                  - name: user
                    header: "üë§ User"
                  - name: model
                    header: "ü§ñ Model"
                  - name: tier
                    header: "üè∑Ô∏è Tier"
                  - name: Value
                    header: "üìä Hits"
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'sum by (user, model, tier) (authorized_hits)'
        
        requests_running:
          kind: Panel
          spec:
            display:
              name: "üîÑ Requests Running"
            plugin:
              kind: StatChart
              spec:
                calculation: last
                format:
                  unit: short
                thresholds:
                  steps:
                    - value: 0
                      color: green
                    - value: 5
                      color: yellow
                    - value: 10
                      color: red
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'sum(vllm:num_requests_running)'
        
        requests_waiting:
          kind: Panel
          spec:
            display:
              name: "‚è≥ Requests Waiting"
            plugin:
              kind: StatChart
              spec:
                calculation: last
                format:
                  unit: short
                thresholds:
                  steps:
                    - value: 0
                      color: green
                    - value: 10
                      color: yellow
                    - value: 50
                      color: red
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'sum(vllm:num_requests_waiting)'
        
        gpu_cache_usage:
          kind: Panel
          spec:
            display:
              name: "üíæ GPU Cache Usage"
            plugin:
              kind: StatChart
              spec:
                calculation: last
                format:
                  unit: percent
                thresholds:
                  steps:
                    - value: 0
                      color: green
                    - value: 70
                      color: yellow
                    - value: 90
                      color: red
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'avg(vllm:gpu_cache_usage_perc)'
        
        total_model_requests:
          kind: Panel
          spec:
            display:
              name: "üìä Total Requests"
            plugin:
              kind: StatChart
              spec:
                calculation: last
                format:
                  unit: short
                sparkline: {}
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'sum(increase(vllm:e2e_request_latency_seconds_count{model_name=~"$model"}[$__range]))'
        
        model_queue_depth:
          kind: Panel
          spec:
            display:
              name: "üìä Model Queue Depth"
            plugin:
              kind: TimeSeriesChart
              spec:
                legend:
                  position: bottom
                  mode: table
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'sum by (model_name) (vllm:num_requests_running{model_name=~"$model"})'
                      seriesNameFormat: "{{model_name}} running"
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'sum by (model_name) (vllm:num_requests_waiting{model_name=~"$model"})'
                      seriesNameFormat: "{{model_name}} waiting"
        
        model_latency:
          kind: Panel
          spec:
            display:
              name: "‚è±Ô∏è Model Inference Latency"
            plugin:
              kind: TimeSeriesChart
              spec:
                legend:
                  position: bottom
                  mode: table
            queries:
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'histogram_quantile(0.5, sum(rate(vllm:e2e_request_latency_seconds_bucket{model_name=~"$model"}[5m])) by (le, model_name))'
                      seriesNameFormat: "{{model_name}} P50"
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'histogram_quantile(0.95, sum(rate(vllm:e2e_request_latency_seconds_bucket{model_name=~"$model"}[5m])) by (le, model_name))'
                      seriesNameFormat: "{{model_name}} P95"
              - kind: TimeSeriesQuery
                spec:
                  plugin:
                    kind: PrometheusTimeSeriesQuery
                    spec:
                      datasource:
                        kind: PrometheusDatasource
                        name: "$datasource"
                      query: 'histogram_quantile(0.99, sum(rate(vllm:e2e_request_latency_seconds_bucket{model_name=~"$model"}[5m])) by (le, model_name))'
                      seriesNameFormat: "{{model_name}} P99"

